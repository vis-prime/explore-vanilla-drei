import{W as ie,V as re,S as de,A as le,a as ce,b as pe,w as me,G as ge,c as ue,s as C,i as he,H as we,L as K,g as te,p as k,o as M,M as U,C as fe,q as ye,t as Se,u as Pe,v as Le,U as Re,R as be,l as ve}from"./three.module-mb-WANHP.js";import{S as Me,O as xe,G as Ce,D as Ee}from"./OrbitControls-BThPDOU9.js";import{H as Fe}from"./HDRI_LIST-DJCqOZOR.js";import{G as Te,T as N,E as A}from"./tween.esm-DFB-vPb4.js";import{E as De,R as Oe,S as Be,a as _e}from"./index-CJeBuP8p.js";import{B as ze}from"./BG_ENV-Dmm91why.js";import{a as Y,M as Q}from"./MODEL_LIST-CtQt_fBO.js";import{L as Ge}from"./LoadingHelper-Bpwvv_dV.js";import{S as q}from"./SpotLightMaterial-CRQYSWHJ.js";import"./EXRLoader-CrxFBtHm.js";import"./RGBELoader-DeKSjiHf.js";import"./GroundProjectedSkybox-ZeOOmZad.js";import"./shaderMaterial-BmLXph0Z.js";import"./constants-9lyQ_GmL.js";const z=new Te;let X,y,O,B,w,S,R,L,Z=new ue;const Ve={pixelRatio:Math.min(1.5,window.devicePixelRatio)},V=new ge,He=new Ce,oe=new Ee;oe.setDecoderPath("https://www.gstatic.com/draco/v1/decoders/");He.setDRACOLoader(oe);new be;let ae=()=>{},j;const H=new Ge({debug:!0});async function it(d){L=d,j=L.addFolder("Scene"),X=new Me,app.appendChild(X.dom),y=new ie({powerPreference:"high-performance",antialias:!1,stencil:!1,depth:!1}),y.setPixelRatio(Ve.pixelRatio),y.setSize(window.innerWidth,window.innerHeight),y.shadowMap.enabled=!0,y.shadowMap.type=re,y.outputColorSpace=de,y.toneMapping=le,app.appendChild(y.domElement),w=new ce(50,window.innerWidth/window.innerHeight,.1,200),w.position.set(5,2,5),w.name="Camera",S=new pe,S.fog=new me(0,10,20),S.add(V),O=new De(y),O.addPass(new Oe(S,w)),B=new Be(S,w,{resolutionScale:.4,luminanceThreshold:0,intensity:120,mipmapBlur:!0,levels:4,radius:.4}),B.ignoreBackground=!0;const r=new _e(w,B);O.addPass(r),R=new xe(w,y.domElement),R.enableDamping=!0,R.dampingFactor=.05,R.minDistance=.5,R.maxDistance=20,R.maxPolarAngle=Math.PI/1.5,R.target.set(0,0,0),window.addEventListener("resize",Ie),document.addEventListener("pointermove",ee);let a=Date.now();app.addEventListener("pointerdown",()=>{a=Date.now()}),app.addEventListener("pointerup",c=>{Date.now()-a<200&&ee(c)});const e=new ze(S,{loadingHelper:H});e.preset=Fe.kloppenheim,e.setEnvType("HDRI"),e.setBGType("Default"),e.addGui(j),S.backgroundBlurriness=.1,S.backgroundIntensity=.01,S.environmentIntensity=.1,j.add(S,"environmentIntensity",0,1),ne(),await Promise.all([e.updateAll(),Ae()]),se()}function Ie(){w.aspect=window.innerWidth/window.innerHeight,w.updateProjectionMatrix(),O.setSize(window.innerWidth,window.innerHeight)}function ne(){X.update(),z.update(),ae(),R.update(),O.render()}function se(){requestAnimationFrame(se),ne()}function ee(d){Z.x=d.clientX/window.innerWidth*2-1,Z.y=-(d.clientY/window.innerHeight)*2+1}const G=(d,r,a)=>{const e=new Se(r,a,d,128,64,!0);return e.translate(0,-d/2,0),e.rotateX(-Math.PI/2),e},x=(d,r,a)=>{r.material.attenuation=d.distance;let e=Math.tan(d.angle)*d.distance;r.geometry=G(d.distance,a,e)};let v;function We({size:d,frames:r=1/0}={}){const a=y,e=new C;a.getSize(e),e.multiplyScalar(a.getPixelRatio());const c=d*e.x,t=d*e.y;console.log("depth tex res",c,t);const o=new Pe(c,t);o.format=Le,o.type=Re,o.name="Depth_Buffer";let i=0;v?v.depthTexture.dispose():v=Ne(c,t),v.depthTexture=o,v.setSize(c,t);const p=()=>{(r===1/0||i<r)&&(a.setRenderTarget(v),a.clear(),a.render(S,w),a.setRenderTarget(null),i++)};return[v.depthTexture,p]}function Ne(d,r,a={}){const e=y,c=d,t=r,o=a,{samples:i=0,depth:p,...g}=o;let m;return m=new he(c,t,{minFilter:K,magFilter:K,colorSpace:e.outputColorSpace,type:we,...g}),m.samples=i,m}async function Ae(){const d=[],r={speed:10,useDepth:!1,depthResolution:1},[a,e,c]=await Promise.all([ke(),je(d),Ue(d)]),t=new C,o=()=>{r.useDepth&&(y.getSize(t),t.multiplyScalar(y.getPixelRatio()))};window.addEventListener("resize",o);let i=()=>{};function p(){if(r.useDepth){const s=We({size:r.depthResolution});let l;for(const n of d)l=n.depth,n.depth=s[0],n.resolution=t;o(),i=s[1],l&&l.dispose()}else for(const s of d)s.depth=null,s.resolution.set(0,0)}L.add(r,"useDepth").onChange(p),L.add(r,"depthResolution",.1,1,.1).onChange(p),L.add(r,"speed",.1,20).onChange();const g=new ve(!0);let m,u;ae=()=>{if(u=g.getDelta()*r.speed,a(u),e(u),c(u),S.environmentRotation.y+=w.position.x>0?u*.01:-u*.01,r.useDepth){for(const s of d)m=s.depth,s.depth=null;i();for(const s of d)s.depth=m}}}async function je(d){const a=(await Y(Q.porsche_1975.url,{loadingHelper:H})).scene;a.name="car",a.traverse(f=>{f.isMesh&&(f.selectOnRaycast=a,f.material.transparent||(f.castShadow=!0,f.receiveShadow=!0))}),V.add(a);const e={FL:a.getObjectByName("wheel_L"),FR:a.getObjectByName("wheel_R"),R:a.getObjectByName("wheels_rear"),body:a.getObjectByName("body"),steerL:a.getObjectByName("steer_L"),steerR:a.getObjectByName("steer_R"),steerVal:0,emit:a.getObjectByName("emit"),lights:a.getObjectByName("lights"),wheenSpinMultiplier:1.8};e.emit.material=new te,e.emit.material.color.set(0),e.emit.material.emissive.set("#ffbb73"),e.lights.material.emissiveIntensity=3,L.add(e.emit.material,"emissiveIntensity",0,50),L.add(e.lights.material,"emissiveIntensity",0,50),B.selection.add(e.emit);const c={distance:8},t=new k;t.intensity=500,t.color.set("#ffbb73"),t.angle=M.degToRad(20),t.penumbra=.2,t.distance=c.distance;const o=t.clone();a.add(t,o),a.add(t.target,o.target),t.position.set(-.66,.66,2),t.target.position.set(-.66,.25,10),o.position.set(.66,.66,2),o.target.position.set(.66,.25,10);let i=.08;const p=new q;p.spotPosition=new C,p.opacity=1,p.lightColor=t.color,p.attenuation=c.distance,p.anglePower=5,p.cameraNear=w.near,p.cameraFar=w.far;const g=new q;g.spotPosition=new C,g.opacity=1,g.lightColor=o.color,g.attenuation=c.distance,g.anglePower=p.anglePower,g.cameraNear=w.near,g.cameraFar=w.far,d.push(p,g);const m=new U(G(c.distance,i,.5),p),u=new U(G(c.distance,i,.5),g);t.add(m),o.add(u);const s=new C;m.lookAt(t.target.position),u.lookAt(o.target.position),x(t,m,i),x(o,u,i);const l=new k(16711680,.05);l.penumbra=1,l.position.set(.62,.64,-2),l.target.position.set(.62,0,-4);const n=l.clone();n.position.set(-.62,.64,-2),n.target.position.set(-.62,0,-4),a.add(l,l.target,n,n.target);function h(f){const T=f.addFolder("HeadLight"),J=T.addFolder("Headlights Volume");J.add(p,"opacity",0,2).onChange(D=>{g.opacity=D}),J.add(p,"anglePower",0,15).onChange(D=>{g.anglePower=D}),T.addColor(t,"color").onChange(()=>{o.color.copy(t.color)}),T.add(t,"intensity",0,1e3).onChange(()=>{o.intensity=t.intensity}),T.add(t,"angle",0,Math.PI/2).onChange(()=>{o.angle=t.angle,x(t,m,i),x(o,u,i)}),T.add(t,"penumbra",0,1).onChange(()=>{o.penumbra=t.penumbra}),T.add(c,"distance",.1,20).onChange(D=>{t.distance=D,o.distance=D,x(t,m,i),x(o,u,i)})}h(L);const b=M.degToRad(15),P=M.degToRad(5),E=.25;function $(){const f=M.mapLinear(e.steerVal,-1,1,-b,b);e.steerL.rotation.y=f,e.steerR.rotation.y=f,e.body.rotation.z=M.mapLinear(e.steerVal,-1,1,-P,P)}const I=new N(e,z).to({steerVal:0}).duration(1e3).easing(A.Elastic.Out).onStart(()=>{I._valuesStart.steerVal=e.steerVal}).onUpdate(()=>{$()});let W=!0;const F=new N(e,z).to({steerVal:1}).duration(1e3).easing(A.Back.Out).delay(1e3).onStart(()=>{F.delay(M.randInt(100,4e3)),W?(F._valuesEnd.steerVal=1,_._valuesEnd.x=E):(F._valuesEnd.steerVal=-1,_._valuesEnd.x=-E),W=!W,_.start()}).onUpdate(()=>{$()});F.chain(I),I.chain(F),setTimeout(()=>{F.startFromCurrentValues()},2e3);const _=new N(a.position,z).to({x:0}).duration(2e3).easing(A.Quadratic.InOut).onStart(()=>{_._valuesStart.x=a.position.x});return f=>{p.spotPosition.copy(m.getWorldPosition(s)),g.spotPosition.copy(u.getWorldPosition(s)),e.FL.rotation.x+=f*e.wheenSpinMultiplier,e.FR.rotation.x+=f*e.wheenSpinMultiplier,e.R.rotation.x+=f*e.wheenSpinMultiplier}}async function ke(){const r=(await Y(Q.road.url,{loadingHelper:H})).scene;r.name="road",r.traverse(o=>{o.isMesh&&(o.selectOnRaycast=r,o.castShadow=!0,o.receiveShadow=!0)});const a=8,e=12,c=a*e,t=[];for(let o=0;o<a;o++){const i=r.clone();i.position.z=o*e-c/2,V.add(i),t.push(i)}return o=>{t.forEach(i=>{i.position.z-=o,i.position.z<-c/2&&(i.position.z+=c)})}}async function Ue(d){const r=new C,a=.1,c=(await Y(Q.pole.url,{loadingHelper:H})).scene;c.name="pole";const t=new fe("#ffbb73");c.position.set(-6,0,0),c.rotation.y=Math.PI/2;const o=c.getObjectByName("emit");o.material=new te,o.material.color.set(0),o.material.emissive.set("#ffbb73"),o.castShadow=!1,o.receiveShadow=!1;const i=[],p=[],g=[],m={gap:15,intensity:1e3,color:t,helper:!1},u=L.addFolder("Street Lamps");u.addColor(m,"color"),u.add(m,"intensity",0,2e3).onChange(s=>{g.forEach(l=>{l.intensity=s})}),u.add(m,"gap",10,30,1).onChange(()=>{for(let s=0;s<i.length;s++){const l=i[s];l.position.z=s*m.gap,console.log(s,l.position.z)}}),B.selection.add(o);for(let s=0;s<4;s++){const l=c.clone();i.push(l),l.position.z=s*m.gap;const n=new k;g.push(n),n.color=t,n.intensity=m.intensity,n.angle=M.degToRad(30),n.penumbra=.5,n.distance=12,n.position.set(0,7.2,1.8),n.target.position.set(0,0,7),n.castShadow=!0,n.shadow.bias=-1e-4,n.radius=1,n.blurSamples=4;const h=new q;console.log(h.uuid),d.push(h),h.spotPosition=new C,h.opacity=.5,h.lightColor=t,h.anglePower=5,h.cameraNear=w.near,h.cameraFar=w.far;const b=new U(G(n.distance,a,.5),h);n.add(b),x(n,b,a),b.lookAt(n.target.getWorldPosition(r)),p.push(b);const P=u.addFolder("lamp "+s);P.add(n.shadow,"bias",-1e-4,1e-4).onChange(()=>{}),P.add(h,"opacity",0,2),P.add(h,"attenuation",0,n.distance),P.add(h,"anglePower",0,15),P.add(h,"cameraNear",0,10),P.add(h,"cameraFar",0,10),l.add(n,n.target);const E=new ye(n);n.helper=E,E.visible=m.helper,S.add(E),V.add(l)}for(let s=0;s<g.length;s++){const l=g[s];p[s].material.spotPosition.copy(l.getWorldPosition(r)),p[s].lookAt(l.target.getWorldPosition(r))}return s=>{for(let l=0;l<i.length;l++){const n=i[l];n.position.z-=s,n.position.z<-m.gap/2*i.length&&(n.position.z+=m.gap*i.length),m.helper&&g.forEach(h=>{h.helper.update()}),p[l].material.spotPosition.copy(p[l].getWorldPosition(r))}}}export{it as default,Ne as useFBO};
