import{S as se,W as ie,V as re,a as de,A as le,b as ce,c as pe,z as me,G as ge,O as ue,d as he,v as C,k as we,H as fe,L as J,h as ee,s as k,r as v,M as j,C as ye,t as Se,w as Pe,x as Le,y as Re,U as be,i as ve,n as Me,R as Ce,o as xe}from"./OrbitControls-R0lqBEeo.js";import{H as Ee}from"./HDRI_LIST-DJCqOZOR.js";import{G as Fe,T as W,E as N}from"./tween.esm-DFB-vPb4.js";import{E as De,R as Te,S as Oe,a as Be}from"./index-B2H7p6tS.js";import{B as _e}from"./BG_ENV-DvPFx4cR.js";import{a as Y,M as q}from"./MODEL_LIST-CX7Ggjim.js";import{L as ze}from"./LoadingHelper-Bpwvv_dV.js";import{S as U}from"./SpotLightMaterial-CnHQ0_Q-.js";import"./EXRLoader-CueWY_mu.js";import"./RGBELoader-C-6F00h6.js";import"./GroundProjectedSkybox-C8DAfX2s.js";import"./shaderMaterial-CnuFB52m.js";import"./constants-CqDbEtfV.js";const _=new Fe;let X,y,T,O,w,S,R,L,K=new he;const Ve={pixelRatio:Math.min(1.5,window.devicePixelRatio)},V=new ge,Ge=new ve,te=new Me;te.setDecoderPath("https://www.gstatic.com/draco/v1/decoders/");Ge.setDRACOLoader(te);new Ce;let oe=()=>{},A;const G=new ze({debug:!0});async function nt(d){L=d,A=L.addFolder("Scene"),X=new se,app.appendChild(X.dom),y=new ie({powerPreference:"high-performance",antialias:!1,stencil:!1,depth:!1}),y.setPixelRatio(Ve.pixelRatio),y.setSize(window.innerWidth,window.innerHeight),y.shadowMap.enabled=!0,y.shadowMap.type=re,y.outputColorSpace=de,y.toneMapping=le,app.appendChild(y.domElement),w=new ce(50,window.innerWidth/window.innerHeight,.1,200),w.position.set(5,2,5),w.name="Camera",S=new pe,S.fog=new me(0,10,20),S.add(V),T=new De(y),T.addPass(new Te(S,w)),O=new Oe(S,w,{resolutionScale:.4,luminanceThreshold:0,intensity:120,mipmapBlur:!0,levels:4,radius:.4}),O.ignoreBackground=!0;const r=new Be(w,O);T.addPass(r),R=new ue(w,y.domElement),R.enableDamping=!0,R.dampingFactor=.05,R.minDistance=.5,R.maxDistance=20,R.maxPolarAngle=Math.PI/1.5,R.target.set(0,0,0),window.addEventListener("resize",He),document.addEventListener("pointermove",Z);let a=Date.now();app.addEventListener("pointerdown",()=>{a=Date.now()}),app.addEventListener("pointerup",c=>{Date.now()-a<200&&Z(c)});const e=new _e(S,{loadingHelper:G});e.preset=Ee.kloppenheim,e.setEnvType("HDRI"),e.setBGType("Default"),e.addGui(A),S.backgroundBlurriness=.1,S.backgroundIntensity=.01,S.environmentIntensity=.1,A.add(S,"environmentIntensity",0,1),ae(),await Promise.all([e.updateAll(),Ne()]),ne()}function He(){w.aspect=window.innerWidth/window.innerHeight,w.updateProjectionMatrix(),T.setSize(window.innerWidth,window.innerHeight)}function ae(){X.update(),_.update(),oe(),R.update(),T.render()}function ne(){requestAnimationFrame(ne),ae()}function Z(d){K.x=d.clientX/window.innerWidth*2-1,K.y=-(d.clientY/window.innerHeight)*2+1}const z=(d,r,a)=>{const e=new Pe(r,a,d,128,64,!0);return e.translate(0,-d/2,0),e.rotateX(-Math.PI/2),e},M=(d,r,a)=>{r.material.attenuation=d.distance;let e=Math.tan(d.angle)*d.distance;r.geometry=z(d.distance,a,e)};function Ie({size:d,frames:r=1/0}={}){const a=y,e=new C;a.getSize(e),e.multiplyScalar(a.getPixelRatio());const c=d*e.x,o=d*e.y;console.log("depth tex res",c,o);const t=new Le(c,o);t.format=Re,t.type=be,t.name="Depth_Buffer";let i=0;const p=We(c,o,{depthTexture:t}),m=()=>{(r===1/0||i<r)&&(a.setRenderTarget(p),a.render(S,w),a.setRenderTarget(null),i++)};return[p.depthTexture,m]}function We(d,r,a){const e=y,c=d,o=r,t=a,{samples:i=0,depth:p,...m}=t;let g;return g=new we(c,o,{minFilter:J,magFilter:J,colorSpace:e.outputColorSpace,type:fe,...m}),g.samples=i,g}async function Ne(){const d=[],r={speed:10,useDepth:!1,depthResolution:1},[a,e,c]=await Promise.all([ke(),Ae(d),je(d)]),o=new C,t=()=>{r.useDepth&&(y.getSize(o),o.multiplyScalar(y.getPixelRatio()))};window.addEventListener("resize",t);let i=()=>{};function p(){if(r.useDepth){const s=Ie({size:r.depthResolution});let l;for(const n of d)l=n.depth,n.depth=s[0],n.resolution=o;t(),i=s[1],l&&l.dispose()}else for(const s of d)s.depth=null,s.resolution.set(0,0)}L.add(r,"useDepth").onChange(p),L.add(r,"depthResolution",.1,1,.1).onChange(p),L.add(r,"speed",.1,20).onChange();const m=new xe(!0);let g,u;oe=()=>{if(u=m.getDelta()*r.speed,a(u),e(u),c(u),S.environmentRotation.y+=w.position.x>0?u*.01:-u*.01,r.useDepth){for(const s of d)g=s.depth,s.depth=null;i();for(const s of d)s.depth=g}}}async function Ae(d){const a=(await Y(q.porsche_1975.url,{loadingHelper:G})).scene;a.name="car",a.traverse(f=>{f.isMesh&&(f.selectOnRaycast=a,f.material.transparent||(f.castShadow=!0,f.receiveShadow=!0))}),V.add(a);const e={FL:a.getObjectByName("wheel_L"),FR:a.getObjectByName("wheel_R"),R:a.getObjectByName("wheels_rear"),body:a.getObjectByName("body"),steerL:a.getObjectByName("steer_L"),steerR:a.getObjectByName("steer_R"),steerVal:0,emit:a.getObjectByName("emit"),lights:a.getObjectByName("lights"),wheenSpinMultiplier:1.8};e.emit.material=new ee,e.emit.material.color.set(0),e.emit.material.emissive.set("#ffbb73"),e.lights.material.emissiveIntensity=3,L.add(e.emit.material,"emissiveIntensity",0,50),L.add(e.lights.material,"emissiveIntensity",0,50),O.selection.add(e.emit);const c={distance:8},o=new k;o.intensity=500,o.color.set("#ffbb73"),o.angle=v.degToRad(20),o.penumbra=.2,o.distance=c.distance;const t=o.clone();a.add(o,t),a.add(o.target,t.target),o.position.set(-.66,.66,2),o.target.position.set(-.66,.25,10),t.position.set(.66,.66,2),t.target.position.set(.66,.25,10);let i=.08;const p=new U;p.spotPosition=new C,p.opacity=1,p.lightColor=o.color,p.attenuation=c.distance,p.anglePower=5,p.cameraNear=w.near,p.cameraFar=w.far;const m=new U;m.spotPosition=new C,m.opacity=1,m.lightColor=t.color,m.attenuation=c.distance,m.anglePower=p.anglePower,m.cameraNear=w.near,m.cameraFar=w.far,d.push(p,m);const g=new j(z(c.distance,i,.5),p),u=new j(z(c.distance,i,.5),m);o.add(g),t.add(u);const s=new C;g.lookAt(o.target.position),u.lookAt(t.target.position),M(o,g,i),M(t,u,i);const l=new k(16711680,.05);l.penumbra=1,l.position.set(.62,.64,-2),l.target.position.set(.62,0,-4);const n=l.clone();n.position.set(-.62,.64,-2),n.target.position.set(-.62,0,-4),a.add(l,l.target,n,n.target);function h(f){const F=f.addFolder("HeadLight"),$=F.addFolder("Headlights Volume");$.add(p,"opacity",0,2).onChange(D=>{m.opacity=D}),$.add(p,"anglePower",0,15).onChange(D=>{m.anglePower=D}),F.addColor(o,"color").onChange(()=>{t.color.copy(o.color)}),F.add(o,"intensity",0,1e3).onChange(()=>{t.intensity=o.intensity}),F.add(o,"angle",0,Math.PI/2).onChange(()=>{t.angle=o.angle,M(o,g,i),M(t,u,i)}),F.add(o,"penumbra",0,1).onChange(()=>{t.penumbra=o.penumbra}),F.add(c,"distance",.1,20).onChange(D=>{o.distance=D,t.distance=D,M(o,g,i),M(t,u,i)})}h(L);const b=v.degToRad(15),P=v.degToRad(5),x=.25;function Q(){const f=v.mapLinear(e.steerVal,-1,1,-b,b);e.steerL.rotation.y=f,e.steerR.rotation.y=f,e.body.rotation.z=v.mapLinear(e.steerVal,-1,1,-P,P)}const H=new W(e,_).to({steerVal:0}).duration(1e3).easing(N.Elastic.Out).onStart(()=>{H._valuesStart.steerVal=e.steerVal}).onUpdate(()=>{Q()});let I=!0;const E=new W(e,_).to({steerVal:1}).duration(1e3).easing(N.Back.Out).delay(1e3).onStart(()=>{E.delay(v.randInt(100,4e3)),I?(E._valuesEnd.steerVal=1,B._valuesEnd.x=x):(E._valuesEnd.steerVal=-1,B._valuesEnd.x=-x),I=!I,B.start()}).onUpdate(()=>{Q()});E.chain(H),H.chain(E),setTimeout(()=>{E.startFromCurrentValues()},2e3);const B=new W(a.position,_).to({x:0}).duration(2e3).easing(N.Quadratic.InOut).onStart(()=>{B._valuesStart.x=a.position.x});return f=>{p.spotPosition.copy(g.getWorldPosition(s)),m.spotPosition.copy(u.getWorldPosition(s)),e.FL.rotation.x+=f*e.wheenSpinMultiplier,e.FR.rotation.x+=f*e.wheenSpinMultiplier,e.R.rotation.x+=f*e.wheenSpinMultiplier}}async function ke(){const r=(await Y(q.road.url,{loadingHelper:G})).scene;r.name="road",r.traverse(t=>{t.isMesh&&(t.selectOnRaycast=r,t.castShadow=!0,t.receiveShadow=!0)});const a=8,e=12,c=a*e,o=[];for(let t=0;t<a;t++){const i=r.clone();i.position.z=t*e-c/2,V.add(i),o.push(i)}return t=>{o.forEach(i=>{i.position.z-=t,i.position.z<-c/2&&(i.position.z+=c)})}}async function je(d){const r=new C,a=.1,c=(await Y(q.pole.url,{loadingHelper:G})).scene;c.name="pole";const o=new ye("#ffbb73");c.position.set(-6,0,0),c.rotation.y=Math.PI/2;const t=c.getObjectByName("emit");t.material=new ee,t.material.color.set(0),t.material.emissive.set("#ffbb73"),t.castShadow=!1,t.receiveShadow=!1;const i=[],p=[],m=[],g={gap:15,intensity:1e3,color:o,helper:!1},u=L.addFolder("Street Lamps");u.addColor(g,"color"),u.add(g,"intensity",0,2e3).onChange(s=>{m.forEach(l=>{l.intensity=s})}),u.add(g,"gap",10,30,1).onChange(()=>{for(let s=0;s<i.length;s++){const l=i[s];l.position.z=s*g.gap,console.log(s,l.position.z)}}),O.selection.add(t);for(let s=0;s<4;s++){const l=c.clone();i.push(l),l.position.z=s*g.gap;const n=new k;m.push(n),n.color=o,n.intensity=g.intensity,n.angle=v.degToRad(30),n.penumbra=.5,n.distance=12,n.position.set(0,7.2,1.8),n.target.position.set(0,0,7),n.castShadow=!0,n.shadow.bias=-1e-4,n.radius=1,n.blurSamples=4;const h=new U;console.log(h.uuid),d.push(h),h.spotPosition=new C,h.opacity=.5,h.lightColor=o,h.anglePower=5,h.cameraNear=w.near,h.cameraFar=w.far;const b=new j(z(n.distance,a,.5),h);n.add(b),M(n,b,a),b.lookAt(n.target.getWorldPosition(r)),p.push(b);const P=u.addFolder("lamp "+s);P.add(n.shadow,"bias",-1e-4,1e-4).onChange(()=>{}),P.add(h,"opacity",0,2),P.add(h,"attenuation",0,n.distance),P.add(h,"anglePower",0,15),P.add(h,"cameraNear",0,10),P.add(h,"cameraFar",0,10),l.add(n,n.target);const x=new Se(n);n.helper=x,x.visible=g.helper,S.add(x),V.add(l)}for(let s=0;s<m.length;s++){const l=m[s];p[s].material.spotPosition.copy(l.getWorldPosition(r)),p[s].lookAt(l.target.getWorldPosition(r))}return s=>{for(let l=0;l<i.length;l++){const n=i[l];n.position.z-=s,n.position.z<-g.gap/2*i.length&&(n.position.z+=g.gap*i.length),g.helper&&m.forEach(h=>{h.helper.update()}),p[l].material.spotPosition.copy(p[l].getWorldPosition(r))}}}export{nt as default,We as useFBO};
