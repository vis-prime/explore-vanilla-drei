import{M as H,g as oe,v as b,u as ne,d as N,r as Q,S as re,W as se,V as ie,b as le,c as q,G as ce,O as de,E as pe,k as me,R as ue,C as J,e as we,Q as ge,X as he,aF as fe,aG as ye,a5 as ve,aH as Se,h as Y,D as be,aA as Re,i as Le,n as Me}from"./OrbitControls-R0lqBEeo.js";import{T as De}from"./TransformControls-C9PpcTYI.js";import{T as x,G as Ee,E as z}from"./tween.esm-DFB-vPb4.js";import{a as Oe,M as Pe}from"./MODEL_LIST-CX7Ggjim.js";import{H as I}from"./HDRI_LIST-DJCqOZOR.js";import{E as xe}from"./EXRLoader-CueWY_mu.js";import{L as ze}from"./LoadingHelper-Bpwvv_dV.js";import{s as Ce}from"./shaderMaterial-CnuFB52m.js";import{v as Ge}from"./constants-CqDbEtfV.js";class _e extends H{constructor(o,s,e,n=128){if(s<=0||e<=0||n<=0)throw new Error("GroundedSkybox height, radius, and resolution must be positive.");const D=new oe(e,2*n,n);D.scale(1,1,-1);const y=D.getAttribute("position"),u=new b;for(let v=0;v<y.count;++v)if(u.fromBufferAttribute(y,v),u.y<0){const E=-s*3/2,O=u.y<E?-s/u.y:1-u.y*u.y/(3*E*E);u.multiplyScalar(O),u.toArray(y.array,3*v)}y.needsUpdate=!0,super(D,new ne({map:o,depthWrite:!1}))}}const Ae=Ce({blur:0,map:null,sdf:null,size:0,resolution:new N},`varying vec2 vUv;
   void main() {
     gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
     vUv = uv;
   }`,`uniform sampler2D sdf;
   uniform sampler2D map;
   uniform float blur;
   uniform float size;
   uniform float time;
   uniform vec2 resolution;
   varying vec2 vUv;
   #include <packing>
   void main() {
     vec2 uv = gl_FragCoord.xy / resolution.xy;
     vec4 t = texture2D(map, uv);
     float k = blur;
     float d = texture2D(sdf, vUv).r/size;
     float alpha = 1.0 - smoothstep(0.0, 1.0, clamp(d/k + 1.0, 0.0, 1.0));
     gl_FragColor = vec4(t.rgb, blur == 0.0 ? t.a : t.a * alpha);
     #include <tonemapping_fragment>
     #include <${Ge>=154?"colorspace_fragment":"encodings_fragment"}>
   }`),Fe=Q.DEG2RAD,je=Q.RAD2DEG;function He(p,o=16/9){return Math.atan(Math.tan(p*Fe*.5)/o)*je*2}const R=new Ee,V=new ze;let k,a,t,d,m,c,h,U=new N;const Te=new ce,Be=new Le,Z=new Me;let w;Z.setDecoderPath("https://www.gstatic.com/draco/v1/decoders/");Be.setDRACOLoader(Z);const $=new ue,C=[];let L,M=new N;const X=new me(1,1,{samples:2});let i,S;const f={cameraFov:50,renderOnlyPortal:!1,portalResolution:1},G={R:null,steerL:null,steerR:null,steerVal:0},F={R:null,steerL:null,steerR:null,steerVal:0};let j=()=>{};async function Je(p){h=p,h.close(),k=new re,app.appendChild(k.dom),a=new se({antialias:!0}),a.setSize(window.innerWidth,window.innerHeight),a.shadowMap.enabled=!0,a.shadowMap.type=ie,a.localClippingEnabled=!0,app.appendChild(a.domElement),t=new le(f.cameraFov,window.innerWidth/window.innerHeight,.1,200),t.position.set(-1,.25,2),t.name="Camera",h.add(f,"cameraFov",10,120,1).onChange(e=>{t.fov=e,t.updateProjectionMatrix()}),d=new q,m=new q,a.getSize(M),d.add(Te),c=new de(t,a.domElement),c.enableDamping=!0,c.dampingFactor=.05,c.minDistance=.1,c.maxDistance=100,c.target.set(0,-.5,-1),c.enabled=!1,w=new De(t,a.domElement),w.addEventListener("dragging-changed",e=>{c.enabled=!e.value}),w.showX=!1,w.showY=!1,w.addEventListener("change",()=>{w.object&&j()}),d.add(w.getHelper()),window.addEventListener("resize",W),document.addEventListener("pointermove",K);let o=Date.now();app.addEventListener("pointerdown",()=>{o=Date.now()}),app.addEventListener("pointerup",e=>{Date.now()-o<200&&(K(e),Ie())}),W(),Ve(),ke();const s=new xe;V.setGlobalProgress(I.old_hall.exr,0),s.load(I.old_hall.exr,e=>{e.mapping=pe,d.environment=e,m.environment=e;const n=new _e(e,5,10);m.add(n)},e=>{V.setGlobalProgress(I.old_hall.exr,e.loaded/e.total)}),te()}function W(){t.aspect=window.innerWidth/window.innerHeight,t.aspect<1&&(t.fov=He(45,t.aspect)),t.updateProjectionMatrix(),a.setSize(window.innerWidth,window.innerHeight),a.getSize(M),X.setSize(M.x*f.portalResolution,M.y*f.portalResolution)}function ee(){k.update(),c.update(),R.update(),f.renderOnlyPortal?a.render(m,t):(a.setRenderTarget(X),a.render(m,t),a.setRenderTarget(null),a.render(d,t))}function te(){requestAnimationFrame(te),ee()}function Ie(){if(C.length=0,$.setFromCamera(U,t),$.intersectObject(i,!0,C),!C.length){w.detach();return}C[0].object.selectOnRaycast&&w.attach(C[0].object.selectOnRaycast)}function K(p){U.x=p.clientX/window.innerWidth*2-1,U.y=-(p.clientY/window.innerHeight)*2+1}function Ve(){d.background=new J().setHSL(Math.random(),.3,.5),a.getSize(M),L=new H(new we,new Ae({map:X.texture,resolution:M})),L.castShadow=!0,L.scale.set(0,0,1),d.add(L);const p=new ge,o=[],s=.5;o.push(-s,-s,0,-s,s,0,s,s,0,s,-s,0),p.setAttribute("position",new he(o,3));const e=new fe(p,new ye({color:16755200,dashSize:.03,gapSize:.01}));e.computeLineDistances(),L.add(e),e.material.color.setHSL(Math.random(),1,.5);const n=h.addFolder("scene");n.open(),n.addColor(d,"background")}async function ke(){m.background=new J().set("#51c995");const o=(await Oe(Pe.porsche_1975.url,{loadingHelper:V})).scene;o.scale.setScalar(.3),o.position.y=-.5,o.position.z=-1,o.name="car",o.traverse(r=>{r.positionBackup=r.position.clone(),r.isMesh&&(r.castShadow=!0,r.receiveShadow=!0,r.selectOnRaycast=o)});const s=new ve(new b(0,0,1),0);h.add(s,"constant",0,5).name("Clipping plane constant"),i=o,S=o.clone(),i.traverse(r=>{r.isMesh&&(r.selectOnRaycast=i,r.material=r.material.clone(),r.material.clippingPlanes=[s],r.material.clipShadows=!0)}),d.add(i),m.add(S),G.R=i.getObjectByName("wheels_rear"),G.steerL=i.getObjectByName("wheel_L"),G.steerR=i.getObjectByName("wheel_R"),F.R=S.getObjectByName("wheels_rear"),F.steerL=S.getObjectByName("wheel_L"),F.steerR=S.getObjectByName("wheel_R"),j=()=>{i.position.z=Q.clamp(i.position.z,-1,1),S.position.copy(i.position);const r=i.position.z*(Math.PI*4);for(const A in G){const B=G[A],ae=F[A];B&&(B.rotation.x=r),B&&(ae.rotation.x=r)}},await a.compileAsync(d,t),await a.compileAsync(m,t);const e=new x(i.position,R).onStart(()=>{}).to({z:0}).duration(3e3).onUpdate((r,A)=>{j()}).easing(z.Quadratic.InOut),n={val:0,camStart:new b,camEnd:new b(2,.2,.5),tarStart:new b,tarEnd:new b(0,0,0)},D=new x(n,R).to({val:1}).delay(100).onStart(()=>{n.camStart.copy(t.position),n.tarStart.copy(c.target)}).duration(1e3).onUpdate(()=>{t.position.lerpVectors(n.camStart,n.camEnd,n.val),c.target.lerpVectors(n.tarStart,n.tarEnd,n.val)}).easing(z.Quadratic.InOut).onComplete(()=>{c.enabled=!0,setTimeout(()=>{w.object||(e.startFromCurrentValues(),h.openAnimated())},1e3)}),y=new x(i.position,R).onStart(()=>{}).to({z:1}).delay(100).duration(3e3).onUpdate((r,A)=>{c.target.copy(i.position),j()}).easing(z.Quadratic.InOut).chain(D).onComplete(()=>{}),u=new x(t.position,R).to({x:1.5,y:.2,z:.25}).duration(2e3).easing(z.Quadratic.InOut).chain(y),v=new x(L.scale,R).to({x:1,y:1}).delay(1e3).duration(3e3).onUpdate(()=>{}).easing(z.Quadratic.InOut).chain(u);ee(),v.start();const E=new Se(.5,.25,150,20),O=new Y({metalness:0,roughness:.2});O.color.setHSL(Math.random(),.4,.5);const g=new H(E,O);m.add(g),g.receiveShadow=!0,g.scale.setScalar(.2),g.position.z=-1,g.position.y=.2,d.add(g.clone()),g.material=O.clone(),g.material.color.setHSL(Math.random(),.4,.5);const l=new be(11272191,3);l.position.set(-2,3,2),l.castShadow=!0,l.shadow.mapSize.width=1024,l.shadow.mapSize.height=1024;const _=6;l.shadow.camera.left=-_,l.shadow.camera.right=_,l.shadow.camera.top=_,l.shadow.camera.bottom=-_,l.shadow.bias=-1e-4,l.shadow.blurSamples=6,l.shadow.radius=3,d.add(l.clone()),m.add(l);const P=new H(new Re(1.5,48).rotateX(-Math.PI/2),new Y({color:"grey"}));P.name="shadowFloor",P.receiveShadow=!0,P.position.set(0,-.5,0),d.add(P),m.add(P.clone());const T=h.addFolder("portalScene");T.open(),T.add(f,"portalResolution",.1,1).name("Portal Res").onChange(()=>W()),T.add(f,"renderOnlyPortal")}export{Je as default};
