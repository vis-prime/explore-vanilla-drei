import{M as T,f as oe,s as b,r as ne,c as N,o as Q,W as re,V as se,a as ie,b as q,G as le,E as ce,i as de,R as pe,C as K,d as me,I as ue,J as we,aB as ge,aC as fe,a1 as he,aD as ye,g as Y,D as ve,aw as Se}from"./three.module-CpOMtsua.js";import{S as be,O as Re,G as Le,D as Me}from"./OrbitControls-FqkbUa6U.js";import{T as De}from"./TransformControls-DIS8GcSd.js";import{T as x,G as Ee,E as z}from"./tween.esm-DFB-vPb4.js";import{a as Oe,M as Pe}from"./MODEL_LIST-Bh-xXQZi.js";import{H as I}from"./HDRI_LIST-DJCqOZOR.js";import{E as xe}from"./EXRLoader-DkJrvfaI.js";import{L as ze}from"./LoadingHelper-Bpwvv_dV.js";import{s as Ce}from"./shaderMaterial-BSjRKRz3.js";import{v as Ge}from"./constants-CSM6w_Ou.js";class _e extends T{constructor(o,s,e,n=128){if(s<=0||e<=0||n<=0)throw new Error("GroundedSkybox height, radius, and resolution must be positive.");const D=new oe(e,2*n,n);D.scale(1,1,-1);const y=D.getAttribute("position"),u=new b;for(let v=0;v<y.count;++v)if(u.fromBufferAttribute(y,v),u.y<0){const E=-s*3/2,O=u.y<E?-s/u.y:1-u.y*u.y/(3*E*E);u.multiplyScalar(O),u.toArray(y.array,3*v)}y.needsUpdate=!0,super(D,new ne({map:o,depthWrite:!1}))}}const je=Ce({blur:0,map:null,sdf:null,size:0,resolution:new N},`varying vec2 vUv;
   void main() {
     gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
     vUv = uv;
   }`,`uniform sampler2D sdf;
   uniform sampler2D map;
   uniform float blur;
   uniform float size;
   uniform float time;
   uniform vec2 resolution;
   varying vec2 vUv;
   #include <packing>
   void main() {
     vec2 uv = gl_FragCoord.xy / resolution.xy;
     vec4 t = texture2D(map, uv);
     float k = blur;
     float d = texture2D(sdf, vUv).r/size;
     float alpha = 1.0 - smoothstep(0.0, 1.0, clamp(d/k + 1.0, 0.0, 1.0));
     gl_FragColor = vec4(t.rgb, blur == 0.0 ? t.a : t.a * alpha);
     #include <tonemapping_fragment>
     #include <${Ge>=154?"colorspace_fragment":"encodings_fragment"}>
   }`),Ae=Q.DEG2RAD,Fe=Q.RAD2DEG;function Te(p,o=16/9){return Math.atan(Math.tan(p*Ae*.5)/o)*Fe*2}const R=new Ee,V=new ze;let U,a,t,d,m,c,f,W=new N;const He=new le,Be=new Le,Z=new Me;let w;Z.setDecoderPath("https://www.gstatic.com/draco/v1/decoders/");Be.setDRACOLoader(Z);const $=new pe,C=[];let L,M=new N;const X=new de(1,1,{samples:2});let i,S;const h={cameraFov:50,renderOnlyPortal:!1,portalResolution:1},G={R:null,steerL:null,steerR:null,steerVal:0},A={R:null,steerL:null,steerR:null,steerVal:0};let F=()=>{};async function Ze(p){f=p,f.close(),U=new be,app.appendChild(U.dom),a=new re({antialias:!0}),a.setSize(window.innerWidth,window.innerHeight),a.shadowMap.enabled=!0,a.shadowMap.type=se,a.localClippingEnabled=!0,app.appendChild(a.domElement),t=new ie(h.cameraFov,window.innerWidth/window.innerHeight,.1,200),t.position.set(-1,.25,2),t.name="Camera",f.add(h,"cameraFov",10,120,1).onChange(e=>{t.fov=e,t.updateProjectionMatrix()}),d=new q,m=new q,a.getSize(M),d.add(He),c=new Re(t,a.domElement),c.enableDamping=!0,c.dampingFactor=.05,c.minDistance=.1,c.maxDistance=100,c.target.set(0,-.5,-1),c.enabled=!1,w=new De(t,a.domElement),w.addEventListener("dragging-changed",e=>{c.enabled=!e.value}),w.showX=!1,w.showY=!1,w.addEventListener("change",()=>{w.object&&F()}),d.add(w.getHelper()),window.addEventListener("resize",k),document.addEventListener("pointermove",J);let o=Date.now();app.addEventListener("pointerdown",()=>{o=Date.now()}),app.addEventListener("pointerup",e=>{Date.now()-o<200&&(J(e),Ie())}),k(),Ve(),Ue();const s=new xe;V.setGlobalProgress(I.old_hall.exr,0),s.load(I.old_hall.exr,e=>{e.mapping=ce,d.environment=e,m.environment=e;const n=new _e(e,5,10);m.add(n)},e=>{V.setGlobalProgress(I.old_hall.exr,e.loaded/e.total)}),te()}function k(){t.aspect=window.innerWidth/window.innerHeight,t.aspect<1&&(t.fov=Te(45,t.aspect)),t.updateProjectionMatrix(),a.setSize(window.innerWidth,window.innerHeight),a.getSize(M),X.setSize(M.x*h.portalResolution,M.y*h.portalResolution)}function ee(){U.update(),c.update(),R.update(),h.renderOnlyPortal?a.render(m,t):(a.setRenderTarget(X),a.render(m,t),a.setRenderTarget(null),a.render(d,t))}function te(){requestAnimationFrame(te),ee()}function Ie(){if(C.length=0,$.setFromCamera(W,t),$.intersectObject(i,!0,C),!C.length){w.detach();return}C[0].object.selectOnRaycast&&w.attach(C[0].object.selectOnRaycast)}function J(p){W.x=p.clientX/window.innerWidth*2-1,W.y=-(p.clientY/window.innerHeight)*2+1}function Ve(){d.background=new K().setHSL(Math.random(),.3,.5),a.getSize(M),L=new T(new me,new je({map:X.texture,resolution:M})),L.castShadow=!0,L.scale.set(0,0,1),d.add(L);const p=new ue,o=[],s=.5;o.push(-s,-s,0,-s,s,0,s,s,0,s,-s,0),p.setAttribute("position",new we(o,3));const e=new ge(p,new fe({color:16755200,dashSize:.03,gapSize:.01}));e.computeLineDistances(),L.add(e),e.material.color.setHSL(Math.random(),1,.5);const n=f.addFolder("scene");n.open(),n.addColor(d,"background")}async function Ue(){m.background=new K().set("#51c995");const o=(await Oe(Pe.porsche_1975.url,{loadingHelper:V})).scene;o.scale.setScalar(.3),o.position.y=-.5,o.position.z=-1,o.name="car",o.traverse(r=>{r.positionBackup=r.position.clone(),r.isMesh&&(r.castShadow=!0,r.receiveShadow=!0,r.selectOnRaycast=o)});const s=new he(new b(0,0,1),0);f.add(s,"constant",0,5).name("Clipping plane constant"),i=o,S=o.clone(),i.traverse(r=>{r.isMesh&&(r.selectOnRaycast=i,r.material=r.material.clone(),r.material.clippingPlanes=[s],r.material.clipShadows=!0)}),d.add(i),m.add(S),G.R=i.getObjectByName("wheels_rear"),G.steerL=i.getObjectByName("wheel_L"),G.steerR=i.getObjectByName("wheel_R"),A.R=S.getObjectByName("wheels_rear"),A.steerL=S.getObjectByName("wheel_L"),A.steerR=S.getObjectByName("wheel_R"),F=()=>{i.position.z=Q.clamp(i.position.z,-1,1),S.position.copy(i.position);const r=i.position.z*(Math.PI*4);for(const j in G){const B=G[j],ae=A[j];B&&(B.rotation.x=r),B&&(ae.rotation.x=r)}},await a.compileAsync(d,t),await a.compileAsync(m,t);const e=new x(i.position,R).onStart(()=>{}).to({z:0}).duration(3e3).onUpdate((r,j)=>{F()}).easing(z.Quadratic.InOut),n={val:0,camStart:new b,camEnd:new b(2,.2,.5),tarStart:new b,tarEnd:new b(0,0,0)},D=new x(n,R).to({val:1}).delay(100).onStart(()=>{n.camStart.copy(t.position),n.tarStart.copy(c.target)}).duration(1e3).onUpdate(()=>{t.position.lerpVectors(n.camStart,n.camEnd,n.val),c.target.lerpVectors(n.tarStart,n.tarEnd,n.val)}).easing(z.Quadratic.InOut).onComplete(()=>{c.enabled=!0,setTimeout(()=>{w.object||(e.startFromCurrentValues(),f.openAnimated())},1e3)}),y=new x(i.position,R).onStart(()=>{}).to({z:1}).delay(100).duration(3e3).onUpdate((r,j)=>{c.target.copy(i.position),F()}).easing(z.Quadratic.InOut).chain(D).onComplete(()=>{}),u=new x(t.position,R).to({x:1.5,y:.2,z:.25}).duration(2e3).easing(z.Quadratic.InOut).chain(y),v=new x(L.scale,R).to({x:1,y:1}).delay(1e3).duration(3e3).onUpdate(()=>{}).easing(z.Quadratic.InOut).chain(u);ee(),v.start();const E=new ye(.5,.25,150,20),O=new Y({metalness:0,roughness:.2});O.color.setHSL(Math.random(),.4,.5);const g=new T(E,O);m.add(g),g.receiveShadow=!0,g.scale.setScalar(.2),g.position.z=-1,g.position.y=.2,d.add(g.clone()),g.material=O.clone(),g.material.color.setHSL(Math.random(),.4,.5);const l=new ve(11272191,3);l.position.set(-2,3,2),l.castShadow=!0,l.shadow.mapSize.width=1024,l.shadow.mapSize.height=1024;const _=6;l.shadow.camera.left=-_,l.shadow.camera.right=_,l.shadow.camera.top=_,l.shadow.camera.bottom=-_,l.shadow.bias=-1e-4,l.shadow.blurSamples=6,l.shadow.radius=3,d.add(l.clone()),m.add(l);const P=new T(new Se(1.5,48).rotateX(-Math.PI/2),new Y({color:"grey"}));P.name="shadowFloor",P.receiveShadow=!0,P.position.set(0,-.5,0),d.add(P),m.add(P.clone());const H=f.addFolder("portalScene");H.open(),H.add(h,"portalResolution",.1,1).name("Portal Res").onChange(()=>k()),H.add(h,"renderOnlyPortal")}export{Ze as default};
